generator client {
  provider   = "prisma-client-js"
  output     = "../src/generated/prisma"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  id        String   @id @db.Uuid
  email     String   @unique
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("profiles")
}

model Category {
  id               String   @id @default(cuid())
  squareCategoryId String   @unique
  name             String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now()) @db.Timestamptz
  updatedAt        DateTime @updatedAt @db.Timestamptz
  items            Item[]

  @@map("categories")
}

model Location {
  id                String     @id @default(cuid())
  squareLocationId  String     @unique
  name              String
  address           String?
  timezone          String?
  currency          String?
  status            String?
  businessHours     Json?
  createdAt         DateTime   @default(now()) @db.Timestamptz
  updatedAt         DateTime   @updatedAt @db.Timestamptz
  orders            Order[]

  @@map("locations")
}

model Item {
  id               String      @id @default(cuid())
  squareItemId     String      @unique
  squareCatalogId  String      @unique
  squareCategoryId String?
  name             String
  category         String?
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now()) @db.Timestamptz
  updatedAt        DateTime    @updatedAt @db.Timestamptz
  categoryRel      Category?   @relation(fields: [squareCategoryId], references: [squareCategoryId])
  lineItems        LineItem[]

  // Performance indexes for AI v3 queries
  @@index([name]) // Item name lookups for AI parameter extraction
  @@index([category]) // Category-based queries
  @@map("items")
}

model Order {
  id              String     @id @default(cuid())
  squareOrderId   String     @unique
  locationId      String
  date            DateTime   @db.Timestamptz
  state           String
  totalAmount     Int        // Amount in cents
  currency        String
  version         Int?
  source          String?
  createdAt       DateTime   @default(now()) @db.Timestamptz
  updatedAt       DateTime   @updatedAt @db.Timestamptz
  location        Location   @relation(fields: [locationId], references: [squareLocationId])
  lineItems       LineItem[]

  // Performance indexes for AI v3 queries
  @@index([date]) // Time-based filtering
  @@index([locationId, date]) // Location + time queries
  @@index([date, locationId]) // Alternative order for different query patterns
  @@index([locationId, totalAmount]) // Location aggregations
  @@index([date, totalAmount]) // Time-based aggregations
  @@map("orders")
}

model LineItem {
  id                   String   @id @default(cuid())
  squareLineItemUid    String   @unique
  orderId              String
  itemId               String?
  name                 String
  quantity             Int
  unitPriceAmount      Int      // Amount in cents
  totalPriceAmount     Int      // Amount in cents
  currency             String
  taxAmount            Int      @default(0)
  discountAmount       Int      @default(0)
  variations           String?
  category             String?
  createdAt            DateTime @default(now()) @db.Timestamptz
  updatedAt            DateTime @updatedAt @db.Timestamptz
  order                Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  item                 Item?    @relation(fields: [itemId], references: [id])

  // Performance indexes for AI v3 queries
  @@index([orderId, itemId]) // Order + item queries
  @@index([itemId, totalPriceAmount]) // Item revenue calculations
  @@index([orderId, itemId, quantity, unitPriceAmount, totalPriceAmount]) // Covering index for common queries
  @@map("line_items")
}

model Conversation {
  id        String        @id @default(cuid())
  userId    String        @map("user_id")
  title     String?
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  messages  ChatMessage[]

  @@map("conversations")
}

model ChatMessage {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  role           String
  content        String
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model SchemaEmbedding {
  id          BigInt                     @id @default(autoincrement())
  objectName  String                     @unique @map("object_name")
  objectType  String                     @map("object_type")
  description String
  embedding   Unsupported("vector(1536)")
  createdAt   DateTime                   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime                   @updatedAt @map("updated_at") @db.Timestamptz

  @@index([objectName], name: "idx_schema_embeddings_object_name")
  @@index([objectType], name: "idx_schema_embeddings_object_type")
  @@map("schema_embeddings")
}

model AlertRule {
  id              String           @id @default(cuid())
  userId          String           @map("user_id")
  name            String
  description     String?          @db.Text
  conditionType   String           @map("condition_type")
  conditionData   Json             @map("condition_data")
  isActive        Boolean          @default(true) @map("is_active")
  frequency       String           @default("once")
  lastTriggeredAt DateTime?        @map("last_triggered_at") @db.Timestamptz
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamptz
  notifications   Notification[]

  // Optimized indexes based on Supabase best practices
  @@index([userId, isActive, lastTriggeredAt]) // Composite for cron queries
  @@index([isActive]) // Index for active alerts filtering
  @@map("alert_rules")
}

model Notification {
  id            String     @id @default(cuid())
  userId        String     @map("user_id")
  alertRuleId   String?    @map("alert_rule_id")
  title         String
  message       String     @db.Text
  type          String     @default("milestone")
  status        String     @default("unread")
  metadata      Json?
  emailSent     Boolean    @default(false) @map("email_sent")
  emailSentAt   DateTime?  @map("email_sent_at") @db.Timestamptz
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime   @updatedAt @map("updated_at") @db.Timestamptz
  alertRule     AlertRule? @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)

  // Optimized indexes
  @@index([userId, status, createdAt]) // For dashboard queries
  @@index([userId, createdAt])         // For sorting
  @@index([emailSent]) // Index for pending emails filtering
  @@map("notifications")
}
