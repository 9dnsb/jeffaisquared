# Text-to-SQL RAG Functions Migration

## Overview

This migration creates two critical Postgres functions for the Text-to-SQL RAG system:
1. `match_schema()` - Vector similarity search for schema retrieval
2. `exec_sql_query()` - Safe execution of AI-generated SQL queries

## Functions Created

### 1. match_schema()

**Purpose:** Retrieve relevant database schema objects using vector similarity search.

**Signature:**
```sql
match_schema(
  query_embedding VECTOR(1536),
  match_threshold FLOAT DEFAULT 0.5,
  match_count INT DEFAULT 10
)
RETURNS TABLE (
  id BIGINT,
  object_name TEXT,
  object_type TEXT,
  description TEXT,
  similarity FLOAT
)
```

**Parameters:**
- `query_embedding` - Vector embedding of user's question (from OpenAI)
- `match_threshold` - Minimum similarity score (0.0-1.0, default 0.5)
- `match_count` - Maximum results to return (default 10)

**Returns:**
- Schema objects ranked by similarity score (highest first)
- Similarity score: 1.0 = identical, 0.0 = completely different

**Example Usage:**
```sql
-- After embeddings are generated, you can search like this:
SELECT * FROM match_schema(
  '[0.1, 0.2, 0.3, ...]'::vector(1536),
  0.7,  -- 70% similarity threshold
  5     -- Return top 5 matches
);
```

**How It Works:**
1. Computes cosine distance between query embedding and all schema embeddings
2. Filters results by similarity threshold
3. Returns top N matches ordered by similarity

### 2. exec_sql_query()

**Purpose:** Safely execute SELECT-only SQL queries generated by AI.

**Signature:**
```sql
exec_sql_query(sql_query TEXT)
RETURNS JSON
```

**Parameters:**
- `sql_query` - SQL query string to execute (must be SELECT)

**Returns:**
- JSON array of query results
- Empty array `[]` if no results

**Security Features:**
1. ✅ **SELECT-only** - Only allows SELECT statements
2. ✅ **Keyword blocking** - Rejects INSERT, UPDATE, DELETE, DROP, etc.
3. ✅ **SQL injection protection** - Blocks multiple statements
4. ✅ **Security definer** - Runs with controlled privileges
5. ✅ **Error handling** - Returns helpful error messages

**Example Usage:**
```sql
-- Valid query
SELECT exec_sql_query('SELECT * FROM orders LIMIT 5');
-- Returns: [{"id": "...", "date": "...", ...}, ...]

-- Invalid query (will fail)
SELECT exec_sql_query('DROP TABLE orders');
-- Returns: ERROR: Only SELECT queries are allowed
```

**Security Validations:**
- Must start with SELECT
- Cannot contain: INSERT, UPDATE, DELETE, DROP, TRUNCATE, ALTER, CREATE, GRANT, REVOKE
- Cannot execute multiple statements (semicolon injection prevention)
- Executes with search_path set to `public` only

## How to Apply

### Step 1: Run Helper Script

```bash
npx tsx scripts/apply-rag-functions.ts
```

This displays the SQL and instructions.

### Step 2: Apply in Supabase

1. Open Supabase Dashboard
2. Go to: **SQL Editor** → **New Query**
3. Copy the SQL from the helper script output
4. Click **Run**

### Step 3: Verify Functions

Run these verification queries:

**Check functions exist:**
```sql
SELECT proname, pg_get_functiondef(oid)
FROM pg_proc
WHERE proname IN ('match_schema', 'exec_sql_query');
```

**Test exec_sql_query (should succeed):**
```sql
SELECT exec_sql_query('SELECT 1 as test');
-- Expected: [{"test":1}]
```

**Test security (should fail):**
```sql
SELECT exec_sql_query('DROP TABLE orders');
-- Expected: ERROR: Only SELECT queries are allowed
```

**Test match_schema (will return empty until embeddings added):**
```sql
SELECT * FROM match_schema(
  ARRAY_FILL(0.1, ARRAY[1536])::vector(1536),
  0.5,
  5
);
-- Expected: 0 rows (no embeddings yet)
```

## Permissions

Functions are granted to:
- `authenticated` - Logged-in users
- `anon` - Anonymous users (if needed)

**Security Note:** Consider restricting to `authenticated` only in production.

## Next Steps

After this migration:

1. ✅ Functions created and verified
2. ➡️ Phase 2: Generate schema embeddings
3. ➡️ Phase 3: Build `/api/text-to-sql` route that uses these functions

## Troubleshooting

### "function does not exist" error

Re-run the migration SQL. Ensure no syntax errors.

### "permission denied" error

Functions are created with `SECURITY DEFINER` - they should execute with owner privileges. If issues persist, check RLS policies.

### match_schema returns 0 rows

This is expected until schema embeddings are generated (Phase 2).

## Rollback

To remove these functions:

```sql
DROP FUNCTION IF EXISTS match_schema CASCADE;
DROP FUNCTION IF EXISTS exec_sql_query CASCADE;
```

## Related Files

- `migration.sql` - The SQL migration
- `scripts/apply-rag-functions.ts` - Helper script
- `TEXT_TO_SQL_RAG_GAMEPLAN.md` - Full implementation plan
